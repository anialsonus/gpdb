-- simple test to check there is no warnings during jumbling of the query
CREATE TABLE table_test_pg_stat_statements
(
    item1 integer,
    item2 integer,
    item3 integer,
    item4 integer
)
DISTRIBUTED BY (item1);
SELECT   
    SUM(item4) AS sum_item1
   ,item2
   ,GROUPING(item1)+GROUPING(item2) AS item_1_2_grouping
FROM
    table_test_pg_stat_statements
WHERE
    item3 = 0
GROUP BY ROLLUP(item1, item2);
 sum_item1 | item2 | item_1_2_grouping 
-----------+-------+-------------------
           |       |                 2
(1 row)

-- start tests for pg_stat_statements logic
-- Known issue: query is not added to pg_stat_statements statistics in
-- case it is planned by GPORCA. So disable GPORCA during tests.
SET optimizer='off';
SELECT pg_stat_statements_reset();
 pg_stat_statements_reset 
--------------------------
 
(1 row)

-- launch 2 equivalent queries  
SELECT
    GROUPING(item1) AS item_1_grouping
FROM
    table_test_pg_stat_statements
WHERE
    item3 = 0
GROUP BY ROLLUP(item1, item2);
 item_1_grouping 
-----------------
(0 rows)

SELECT
    GROUPING(item1) AS item_1_grouping
FROM
    table_test_pg_stat_statements
WHERE
    item3 = 1
GROUP BY ROLLUP(item1, item2);
 item_1_grouping 
-----------------
(0 rows)

-- pg_stat_statements statistics should have 2 calls for 1 entry
-- corresponding to the two preceding SELECT queries
SELECT query, calls FROM pg_stat_statements ORDER BY QUERY;
                 query                  | calls 
----------------------------------------+-------
 SELECT                                +|     2
     GROUPING(item1) AS item_1_grouping+| 
 FROM                                  +| 
     table_test_pg_stat_statements     +| 
 WHERE                                 +| 
     item3 = ?                         +| 
 GROUP BY ROLLUP(item1, item2);         | 
 SELECT pg_stat_statements_reset();     |     1
(2 rows)

-- launch not equivalent query
SELECT
    GROUPING(item2) AS item_1_grouping
FROM
    table_test_pg_stat_statements
WHERE
    item3 = 0
GROUP BY ROLLUP(item1, item2);
 item_1_grouping 
-----------------
(0 rows)

-- check that it has separate entry
SELECT query, calls FROM pg_stat_statements ORDER BY QUERY;
                            query                            | calls 
-------------------------------------------------------------+-------
 SELECT                                                     +|     2
     GROUPING(item1) AS item_1_grouping                     +| 
 FROM                                                       +| 
     table_test_pg_stat_statements                          +| 
 WHERE                                                      +| 
     item3 = ?                                              +| 
 GROUP BY ROLLUP(item1, item2);                              | 
 SELECT                                                     +|     1
     GROUPING(item2) AS item_1_grouping                     +| 
 FROM                                                       +| 
     table_test_pg_stat_statements                          +| 
 WHERE                                                      +| 
     item3 = ?                                              +| 
 GROUP BY ROLLUP(item1, item2);                              | 
 SELECT pg_stat_statements_reset();                          |     1
 SELECT query, calls FROM pg_stat_statements ORDER BY QUERY; |     1
(4 rows)

-- change alias name
SELECT
    GROUPING(item2) AS item_2_grouping
FROM
    table_test_pg_stat_statements
WHERE
    item3 = 0
GROUP BY ROLLUP(item1, item2);
 item_2_grouping 
-----------------
(0 rows)

-- check that recent request was added to preceding entry
SELECT query, calls FROM pg_stat_statements ORDER BY QUERY;
                            query                            | calls 
-------------------------------------------------------------+-------
 SELECT                                                     +|     2
     GROUPING(item1) AS item_1_grouping                     +| 
 FROM                                                       +| 
     table_test_pg_stat_statements                          +| 
 WHERE                                                      +| 
     item3 = ?                                              +| 
 GROUP BY ROLLUP(item1, item2);                              | 
 SELECT                                                     +|     2
     GROUPING(item2) AS item_1_grouping                     +| 
 FROM                                                       +| 
     table_test_pg_stat_statements                          +| 
 WHERE                                                      +| 
     item3 = ?                                              +| 
 GROUP BY ROLLUP(item1, item2);                              | 
 SELECT pg_stat_statements_reset();                          |     1
 SELECT query, calls FROM pg_stat_statements ORDER BY QUERY; |     2
(4 rows)

-- check that different grouping options result in separate entries
SELECT
    COUNT (*)
FROM
    table_test_pg_stat_statements
GROUP BY ROLLUP(item1, item2, item3, item4);
 count 
-------
(0 rows)

SELECT
    COUNT (*)
FROM
    table_test_pg_stat_statements
GROUP BY CUBE(item1, item2, item3, item4);
 count 
-------
(0 rows)

SELECT
    COUNT (*)
FROM
    table_test_pg_stat_statements
GROUP BY GROUPING SETS(item1, item2, item3, item4);
 count 
-------
(0 rows)

SELECT
    COUNT (*)
FROM
    table_test_pg_stat_statements
GROUP BY GROUPING SETS((item1, item2), (item3, item4));
 count 
-------
(0 rows)

SELECT
    COUNT (*)
FROM
    table_test_pg_stat_statements
GROUP BY item1, item2, item3, item4;
 count 
-------
(0 rows)

SELECT query, calls FROM pg_stat_statements ORDER BY QUERY;
                            query                            | calls 
-------------------------------------------------------------+-------
 SELECT                                                     +|     1
     COUNT (*)                                              +| 
 FROM                                                       +| 
     table_test_pg_stat_statements                          +| 
 GROUP BY CUBE(item1, item2, item3, item4);                  | 
 SELECT                                                     +|     1
     COUNT (*)                                              +| 
 FROM                                                       +| 
     table_test_pg_stat_statements                          +| 
 GROUP BY GROUPING SETS((item1, item2), (item3, item4));     | 
 SELECT                                                     +|     1
     COUNT (*)                                              +| 
 FROM                                                       +| 
     table_test_pg_stat_statements                          +| 
 GROUP BY GROUPING SETS(item1, item2, item3, item4);         | 
 SELECT                                                     +|     1
     COUNT (*)                                              +| 
 FROM                                                       +| 
     table_test_pg_stat_statements                          +| 
 GROUP BY item1, item2, item3, item4;                        | 
 SELECT                                                     +|     1
     COUNT (*)                                              +| 
 FROM                                                       +| 
     table_test_pg_stat_statements                          +| 
 GROUP BY ROLLUP(item1, item2, item3, item4);                | 
 SELECT                                                     +|     2
     GROUPING(item1) AS item_1_grouping                     +| 
 FROM                                                       +| 
     table_test_pg_stat_statements                          +| 
 WHERE                                                      +| 
     item3 = ?                                              +| 
 GROUP BY ROLLUP(item1, item2);                              | 
 SELECT                                                     +|     2
     GROUPING(item2) AS item_1_grouping                     +| 
 FROM                                                       +| 
     table_test_pg_stat_statements                          +| 
 WHERE                                                      +| 
     item3 = ?                                              +| 
 GROUP BY ROLLUP(item1, item2);                              | 
 SELECT pg_stat_statements_reset();                          |     1
 SELECT query, calls FROM pg_stat_statements ORDER BY QUERY; |     3
(9 rows)

-- check several parameters options in ROLLUP
-- all should result in separate entries
SELECT pg_stat_statements_reset();
 pg_stat_statements_reset 
--------------------------
 
(1 row)

SELECT
    COUNT (*)
FROM
    table_test_pg_stat_statements
GROUP BY ROLLUP(item1, item2);
 count 
-------
(0 rows)

SELECT
    COUNT (*)
FROM
    table_test_pg_stat_statements
GROUP BY ROLLUP(item2, item3);
 count 
-------
(0 rows)

SELECT
    COUNT (*)
FROM
    table_test_pg_stat_statements
GROUP BY ROLLUP(item3, item4);
 count 
-------
(0 rows)

SELECT query, calls FROM pg_stat_statements ORDER BY QUERY;
               query                | calls 
------------------------------------+-------
 SELECT                            +|     1
     COUNT (*)                     +| 
 FROM                              +| 
     table_test_pg_stat_statements +| 
 GROUP BY ROLLUP(item1, item2);     | 
 SELECT                            +|     1
     COUNT (*)                     +| 
 FROM                              +| 
     table_test_pg_stat_statements +| 
 GROUP BY ROLLUP(item2, item3);     | 
 SELECT                            +|     1
     COUNT (*)                     +| 
 FROM                              +| 
     table_test_pg_stat_statements +| 
 GROUP BY ROLLUP(item3, item4);     | 
 SELECT pg_stat_statements_reset(); |     1
(4 rows)

-- check several parameters options in CUBE
-- all should result in separate entries
SELECT pg_stat_statements_reset();
 pg_stat_statements_reset 
--------------------------
 
(1 row)

SELECT
    COUNT (*)
FROM
    table_test_pg_stat_statements
GROUP BY CUBE(item1, item2);
 count 
-------
(0 rows)

SELECT
    COUNT (*)
FROM
    table_test_pg_stat_statements
GROUP BY CUBE(item2, item3);
 count 
-------
(0 rows)

SELECT
    COUNT (*)
FROM
    table_test_pg_stat_statements
GROUP BY CUBE(item3, item4);
 count 
-------
(0 rows)

SELECT query, calls FROM pg_stat_statements ORDER BY QUERY;
               query                | calls 
------------------------------------+-------
 SELECT                            +|     1
     COUNT (*)                     +| 
 FROM                              +| 
     table_test_pg_stat_statements +| 
 GROUP BY CUBE(item1, item2);       | 
 SELECT                            +|     1
     COUNT (*)                     +| 
 FROM                              +| 
     table_test_pg_stat_statements +| 
 GROUP BY CUBE(item2, item3);       | 
 SELECT                            +|     1
     COUNT (*)                     +| 
 FROM                              +| 
     table_test_pg_stat_statements +| 
 GROUP BY CUBE(item3, item4);       | 
 SELECT pg_stat_statements_reset(); |     1
(4 rows)

-- check several parameters options in GROUPING SETS
-- all should result in separate entries
SELECT pg_stat_statements_reset();
 pg_stat_statements_reset 
--------------------------
 
(1 row)

SELECT
    COUNT (*)
FROM
    table_test_pg_stat_statements
GROUP BY GROUPING SETS((item1, item2), (item2, item3));
 count 
-------
(0 rows)

SELECT
    COUNT (*)
FROM
    table_test_pg_stat_statements
GROUP BY GROUPING SETS((item1, item2), (item3, item4));
 count 
-------
(0 rows)

SELECT query, calls FROM pg_stat_statements ORDER BY QUERY;
                          query                          | calls 
---------------------------------------------------------+-------
 SELECT                                                 +|     1
     COUNT (*)                                          +| 
 FROM                                                   +| 
     table_test_pg_stat_statements                      +| 
 GROUP BY GROUPING SETS((item1, item2), (item2, item3)); | 
 SELECT                                                 +|     1
     COUNT (*)                                          +| 
 FROM                                                   +| 
     table_test_pg_stat_statements                      +| 
 GROUP BY GROUPING SETS((item1, item2), (item3, item4)); | 
 SELECT pg_stat_statements_reset();                      |     1
(3 rows)

-- check several options in simple GROUP BY
-- all should result in separate entries
SELECT pg_stat_statements_reset();
 pg_stat_statements_reset 
--------------------------
 
(1 row)

SELECT
    COUNT (*)
FROM
    table_test_pg_stat_statements
GROUP BY item1, item2;
 count 
-------
(0 rows)

SELECT
    COUNT (*)
FROM
    table_test_pg_stat_statements
GROUP BY item2, item3;
 count 
-------
(0 rows)

SELECT
    COUNT (*)
FROM
    table_test_pg_stat_statements
GROUP BY item3, item4;
 count 
-------
(0 rows)

SELECT
    COUNT (*)
FROM
    table_test_pg_stat_statements
GROUP BY item1, item2, item3;
 count 
-------
(0 rows)

SELECT query, calls FROM pg_stat_statements ORDER BY QUERY;
               query                | calls 
------------------------------------+-------
 SELECT                            +|     1
     COUNT (*)                     +| 
 FROM                              +| 
     table_test_pg_stat_statements +| 
 GROUP BY item1, item2;             | 
 SELECT                            +|     1
     COUNT (*)                     +| 
 FROM                              +| 
     table_test_pg_stat_statements +| 
 GROUP BY item1, item2, item3;      | 
 SELECT                            +|     1
     COUNT (*)                     +| 
 FROM                              +| 
     table_test_pg_stat_statements +| 
 GROUP BY item2, item3;             | 
 SELECT                            +|     1
     COUNT (*)                     +| 
 FROM                              +| 
     table_test_pg_stat_statements +| 
 GROUP BY item3, item4;             | 
 SELECT pg_stat_statements_reset(); |     1
(5 rows)

SET optimizer='on';
DROP TABLE table_test_pg_stat_statements;
